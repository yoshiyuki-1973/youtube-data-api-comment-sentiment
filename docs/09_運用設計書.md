# 運用設計書
YouTube分析バッチシステム

## 1. 運用方針
- 手動でバッチ実行する（スケジューラ不使用）
- Dockerコマンドによる実行
- 詳細なDocker操作は [10_Docker操作ガイド.md](./10_Docker操作ガイド.md) を参照

## 2. 起動・停止

### 2.1 コンテナ起動
```bash
docker compose up -d
```

### 2.2 コンテナ停止
```bash
docker compose down
```

### 2.3 ログ確認
```bash
docker compose logs -f app
```

### 2.4 バッチ実行
```bash
# 単一動画の分析
docker compose exec app python main.py --video-id VIDEO_ID

# コメント取得件数を指定
docker compose exec app python main.py --video-id VIDEO_ID --comment-limit 50

# 複数動画の分析
docker compose exec app python main.py --video-ids VIDEO_ID1,VIDEO_ID2,VIDEO_ID3
```

## 3. 再実行
JSONが残っていれば再集計可能。
既存JSONを使用する場合はAPIを呼ばずに処理される。

## 4. ログ設計

### 4.1 ログ出力先
| 種類 | 出力先 | 説明 |
|-----|--------|------|
| アプリケーションログ | ./logs/app.log | バッチ処理の実行ログ |
| エラーログ | ./logs/error.log | エラー・例外のみ |

### 4.2 ログフォーマット
```
[%(asctime)s] %(levelname)s %(name)s: %(message)s
```

例:
```
[2025-01-21 10:30:00] INFO fetch: Fetching video: abc123
[2025-01-21 10:30:01] INFO sentiment: Analyzed 10 comments
[2025-01-21 10:30:02] ERROR fetch: API quota exceeded
```

### 4.3 ログレベル
| レベル | 用途 |
|-------|------|
| DEBUG | 詳細なデバッグ情報 |
| INFO | 正常処理の記録 |
| WARNING | 警告（処理は継続） |
| ERROR | エラー（処理中断） |

### 4.4 ログローテーション
| 設定項目 | 値 |
|---------|-----|
| ローテーション単位 | 日次 |
| 保持期間 | 7日間 |
| 最大ファイルサイズ | 10MB |
| 圧縮 | gzip |

設定例（logging.conf）:
```ini
[handler_fileHandler]
class=logging.handlers.TimedRotatingFileHandler
args=('./logs/app.log', 'midnight', 1, 7)
```

## 5. 監視項目

| 項目 | 閾値 | 対応 |
|-----|------|------|
| APIクォータ使用量 | 8,000ユニット/日 | 警告ログ出力 |
| バッチ実行時間 | 30分超 | 警告ログ出力 |
| エラー発生 | 1件以上 | error.log確認 |

## 6. 障害対応

### 6.1 APIクォータ超過時
1. error.logで403エラーを確認
2. 翌日（太平洋時間0時）にクォータリセット
3. 処理動画数を減らして再実行

### 6.2 MySQL接続エラー時
1. `docker compose ps` でコンテナ状態確認
2. `docker compose restart mysql` で再起動
3. 復旧後バッチ再実行
