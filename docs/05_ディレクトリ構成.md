# ディレクトリ構成

## 概要

本ドキュメントは、YouTube Data API Comment Sentimentプロジェクトのディレクトリ構成を説明します。

本プロジェクトは **Docker実行に一本化** しています。

## プロジェクトルート構造

```
youtube-data-api-comment-sentiment/
├── .env                      # 環境変数設定ファイル（Git管理外）
├── .env.example              # 環境変数のテンプレート
├── .gitignore                # Git除外設定
├── docker-compose.yml        # Docker Compose設定
├── Dockerfile                # Dockerイメージ定義
├── init.sql                  # MySQL初期化スクリプト
├── pytest.ini                # pytest設定ファイル
├── requirements.txt          # Python依存パッケージ一覧
├── README.md                 # プロジェクト概要
├── CHANGELOG.md              # 変更履歴
├── CLAUDE.md                 # Claude AIとの対話履歴
├── REVIEW_SUMMARY.md         # レビューサマリー
│
├── app/                      # アプリケーションコード
├── data/                     # データ保存ディレクトリ
├── docs/                     # ドキュメント
├── logs/                     # ログファイル
└── tests/                    # テストコード
```

## app/ - アプリケーションコード

```
app/
├── __init__.py               # パッケージ初期化
├── main.py                   # メインエントリーポイント（バッチ処理）
├── streamlit_app.py          # Streamlit Webアプリ
│
├── fetch/                    # YouTube API データ取得
│   ├── __init__.py
│   └── youtube.py            # YouTube Data API クライアント
│
├── sentiment/                # 感情分析
│   ├── __init__.py
│   └── analyzer.py           # 感情分析エンジン（3モデルアンサンブル）
│
├── repository/               # データベース操作
│   ├── __init__.py
│   └── mysql.py              # MySQLリポジトリ
│
├── aggregate/                # データ集計・要約
│   ├── __init__.py
│   └── summarizer.py         # コメント集計・要約
│
├── data/                     # アプリ内データ保存
│   └── json/                 # JSON形式のデータ
│
└── logs/                     # アプリケーションログ
```

### 各モジュールの役割

| モジュール     | ファイル           | 役割                                       |
| -------------- | ------------------ | ------------------------------------------ |
| **メイン**     | `main.py`          | バッチ処理のエントリーポイント             |
|                | `streamlit_app.py` | WebUIのエントリーポイント                  |
| **fetch**      | `youtube.py`       | YouTube Data APIからの動画・コメント取得   |
| **sentiment**  | `analyzer.py`      | 3モデルアンサンブル + ルールベース感情分析 |
| **repository** | `mysql.py`         | MySQLへのデータ永続化（接続プール対応）    |
| **aggregate**  | `summarizer.py`    | コメント集計・統計計算・要約生成           |

## data/ - データ保存ディレクトリ

```
data/
├── json/                     # JSON形式のエクスポートデータ
│   ├── video_*.json          # 動画情報
│   └── comments_*.json       # コメント情報
│
└── mysql/                    # MySQLデータディレクトリ（Dockerボリューム）
    ├── youtube_analytics/    # アプリケーションデータベース
    ├── mysql/                # MySQL システムテーブル
    ├── performance_schema/   # パフォーマンススキーマ
    └── sys/                  # システムビュー
```

### データ管理方針

- **JSON**: API取得データのバックアップ、分析用エクスポート
- **MySQL**: 構造化データの永続化、クエリ最適化
- **Dockerボリューム**: `./data/mysql` をマウントし、コンテナ削除後もデータ保持

## docs/ - ドキュメント

```
docs/
├── 01_要件定義書.md          # プロジェクト要件
├── 02_基本設計書.md          # システム基本設計
├── 03_詳細設計書.md          # 詳細設計仕様
├── 04_データ仕様書.md        # データベース・API仕様
├── 05_ディレクトリ構成.md    # 本ドキュメント
├── 06_命名規約.md            # コーディング規約
├── 07_開発ガイド.md          # VSCodeローカル開発手順
├── 08_感情分析仕様書.md      # 感情分析の仕様
├── 09_単体テスト仕様書.md    # ユニットテスト仕様
├── 10_運用設計書.md          # 運用・保守設計
└── 11_Docker操作ガイド.md    # Docker環境構築・運用
```

## logs/ - ログファイル

```
logs/
├── app_YYYYMMDD.log          # アプリケーションログ（日次ローテーション）
├── error_YYYYMMDD.log        # エラーログ
└── access_YYYYMMDD.log       # アクセスログ（Streamlit）
```

### ログ管理方針

- **日次ローテーション**: 日付ごとにファイル分割
- **レベル分離**: INFO/ERROR で別ファイル
- **保持期間**: 30日間（自動削除）

## models/ - 学習済みモデル

```
models/
├── README.md                 # モデル管理説明
└── sentiment-finetuned/      # Fine-tunedモデル（作成後）
    ├── config.json           # モデル設定
    ├── model.safetensors     # モデルウェイト
    ├── tokenizer_config.json # トークナイザー設定
    ├── special_tokens_map.json # 特殊トークン定義
    └── vocab.txt             # 語彙リスト
```

### モデル管理方針

- **Dockerボリューム**: `./models:/app/models` でマウント
- **永続化**: コンテナ削除後もモデルファイル保持
- **Git管理**: モデルファイルは大容量のため `.gitignore` で除外
- **バージョン管理**: モデル更新時は日付付きバックアップ
- **共有方法**: Hugging Face Hub やクラウドストレージで共有

## tests/ - テストコード

```
tests/
├── __init__.py               # パッケージ初期化
├── conftest.py               # pytest共通設定・フィクスチャ
├── test_fetch.py             # YouTube取得機能のテスト
├── test_analyzer.py          # 感情分析機能のテスト
├── test_repository.py        # データベース機能のテスト
├── test_summarizer.py        # 集計機能のテスト
├── test_truncate.py          # UTF-8安全切り詰め機能のテスト
│
└── fixtures/                 # テスト用フィクスチャデータ
    ├── video_response.json   # 動画APIレスポンスのモック
    └── comments_response.json # コメントAPIレスポンスのモック
```

### テスト方針

- **ユニットテスト**: 各モジュールの単体機能テスト
- **モックデータ**: `fixtures/` で外部API依存を排除
- **カバレッジ**: 80%以上を目標

## 設定ファイル

### .env（環境変数）

```bash
# YouTube Data API
YOUTUBE_API_KEY=your_api_key_here
COMMENT_LIMIT=100

# MySQL
MYSQL_HOST=mysql
MYSQL_PORT=3306
MYSQL_DATABASE=youtube_analytics
MYSQL_USER=user
MYSQL_PASSWORD=password
MYSQL_ROOT_PASSWORD=rootpassword

# Fine-tuned Model（オプション）
USE_FINETUNED_MODEL=false
FINETUNED_MODEL_PATH=/app/models/sentiment-finetuned
```

### docker-compose.yml（抜粋）

```yaml
services:
  streamlit:
    volumes:
      - ./app:/app
      - ./data/json:/app/data/json
      - ./logs:/app/logs
      - ./models:/app/models # モデル永続化

  app:
    volumes:
      - ./app:/app
      - ./data/json:/app/data/json
      - ./logs:/app/logs
      - ./models:/app/models # モデル永続化

  mysql:
    volumes:
      - ./data/mysql:/var/lib/mysql # データ永続化
```

## ボリュームマウント戦略

| ホストパス     | コンテナパス     | 目的                         |
| -------------- | ---------------- | ---------------------------- |
| `./app`        | `/app`           | ソースコードのホットリロード |
| `./data/json`  | `/app/data/json` | JSONデータの共有・保存       |
| `./logs`       | `/app/logs`      | ログファイルの永続化         |
| `./models`     | `/app/models`    | 学習済みモデルの永続化       |
| `./data/mysql` | `/var/lib/mysql` | MySQLデータの永続化          |

### メリット

- **開発効率**: コード変更が即座に反映
- **データ保護**: コンテナ削除後もデータ保持
- **デバッグ**: ホスト側からログやデータを確認可能

## Git管理外ファイル

`.gitignore` で以下を除外：

```gitignore
.env                 # 機密情報
data/                # データファイル（大容量）
logs/                # ログファイル（自動生成）
models/              # 学習済みモデル（数百MB〜数GB）
!models/README.md    # モデル取得方法の説明のみ管理
__pycache__/         # Pythonキャッシュ
.pytest_cache/       # pytestキャッシュ
*.pyc                # コンパイル済みPython
```

## 推奨ディレクトリ作成手順

プロジェクトセットアップ時に必要なディレクトリを作成：

```bash
# プロジェクトルートで実行
mkdir -p data/json
mkdir -p data/mysql
mkdir -p logs
mkdir -p models
mkdir -p app/data/json
mkdir -p app/logs
mkdir -p tests/fixtures
```

Docker Composeで自動的にマウントポイントが作成されますが、事前作成を推奨します。

## まとめ

### ディレクトリ設計の原則

1. **責務の分離**: app/配下を機能別に分割（fetch, sentiment, repository, aggregate）
2. **永続化戦略**: Dockerボリュームマウントでデータ・モデル保護
3. **開発効率**: ホットリロード対応でコンテナ再起動不要
4. **テスト容易性**: tests/でモックを用いた独立テスト
5. **ドキュメント充実**: docs/で設計から運用まで一元管理

### 関連ドキュメント

- システム構成: [02\_基本設計書.md](02_基本設計書.md)
- データ仕様: [04\_データ仕様書.md](04_データ仕様書.md)
- コーディング規約: [06\_命名規約.md](06_命名規約.md)
- 運用ガイド: [10\_運用設計書.md](10_運用設計書.md)
