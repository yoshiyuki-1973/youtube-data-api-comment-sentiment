# 開発ガイド

VSCodeを使用したローカル開発環境のセットアップと開発ワークフローを説明します。

## 目次

1. [前提条件](#前提条件)
2. [初回セットアップ](#初回セットアップ)
3. [開発ワークフロー](#開発ワークフロー)
4. [よく使うコマンド](#よく使うコマンド)
5. [デバッグ方法](#デバッグ方法)
6. [コーディング規約](#コーディング規約)
7. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

本プロジェクトの実行・開発は **Dockerに一本化** しています。

### 必須ツール

| ツール         | バージョン | 用途               |
| -------------- | ---------- | ------------------ |
| Docker Desktop | 最新版     | コンテナ環境       |
| Docker Compose | v2.0以上   | マルチコンテナ管理 |
| VSCode         | 最新版     | エディタ           |
| Git            | 最新版     | バージョン管理     |

### 推奨VSCode拡張機能

```
必須：
- ms-python.python (Python拡張)
- ms-azuretools.vscode-docker (Docker拡張)

推奨：
- ms-python.black-formatter (コードフォーマット)
- ms-python.flake8 (リンター)
- donjayamanne.githistory (Git履歴)
- eamodio.gitlens (Git強化)
- yzhang.markdown-all-in-one (Markdown編集)
```

拡張機能のインストール：

```bash
# VSCode コマンドパレット (Ctrl+Shift+P)
> Extensions: Install Extensions
```

---

## 初回セットアップ

### 1. リポジトリのクローン

```powershell
# リポジトリをクローン
git clone <repository-url>
cd youtube-data-api-comment-sentiment

# VSCodeで開く
code .
```

### 2. 環境変数の設定

```powershell
# .env.exampleをコピー
Copy-Item .env.example .env

# .envを編集（必須項目を設定）
notepad .env
```

必須設定項目：

```env
YOUTUBE_API_KEY=your_api_key_here
MYSQL_PASSWORD=your_secure_password
MYSQL_ROOT_PASSWORD=your_root_password
```

### 3. Dockerイメージのビルド

```powershell
# イメージをビルド
docker-compose build

# ビルドに成功したら起動
docker-compose up -d
```

初回ビルドは5-10分程度かかります（モデルのダウンロード含む）。

### 4. 動作確認

```powershell
# コンテナの状態確認
docker-compose ps

# ログ確認
docker-compose logs -f streamlit

# ブラウザでアクセス
# Streamlit: http://localhost:8501
# Adminer: http://localhost:8080
```

---

## 開発ワークフロー

### 基本的な開発サイクル

```
1. ブランチ作成
   ↓
2. コード編集（VSCode）
   ↓
3. ローカルテスト
   ↓
4. コミット & プッシュ
   ↓
5. プルリクエスト
```

### 1. 新機能開発の開始

```powershell
# 最新のmainブランチを取得
git checkout main
git pull origin main

# 機能ブランチを作成
git checkout -b feature/your-feature-name
```

### 2. コードの編集

ソースコードは `./app/` にマウントされているため、VSCodeで編集すると**即座にコンテナ内に反映**されます。

```
app/
├── main.py              # CLIエントリーポイント
├── streamlit_app.py     # Streamlit UI
├── fetch/youtube.py     # YouTube API
├── sentiment/analyzer.py # 感情分析
├── aggregate/summarizer.py # 集計
└── repository/mysql.py  # DB操作
```

### 3. 変更の確認

#### Streamlitの場合（自動リロード）

- ファイル保存時に自動でリロード
- ブラウザで http://localhost:8501 を確認

#### CLIの場合

```powershell
# コンテナ内でPythonスクリプトを実行
docker-compose exec app python main.py --video-id <VIDEO_ID>
```

### 4. テストの実行

```powershell
# 全テストを実行
docker-compose exec app pytest

# 詳細出力付き
docker-compose exec app pytest -v

# 特定のテストファイル
docker-compose exec app pytest tests/test_analyzer.py

# カバレッジ付き
docker-compose exec app pytest --cov=app --cov-report=html
```

### 5. コミット

```powershell
# 変更を確認
git status

# ステージング
git add <files>

# コミット（わかりやすいメッセージで）
git commit -m "feat: 新機能の説明"

# プッシュ
git push origin feature/your-feature-name
```

---

## よく使うコマンド

### Docker操作

```powershell
# コンテナの起動
docker-compose up -d

# コンテナの停止
docker-compose down

# コンテナの再起動
docker-compose restart

# 特定のコンテナを再起動
docker-compose restart streamlit

# イメージの再ビルド
docker-compose build

# キャッシュなしで再ビルド
docker-compose build --no-cache

# コンテナのログを表示
docker-compose logs -f

# 特定のコンテナのログ
docker-compose logs -f streamlit
```

### コンテナ内でコマンド実行

```powershell
# コンテナ内でシェルを起動
docker-compose exec app /bin/bash

# Pythonスクリプトを実行
docker-compose exec app python main.py --video-id <VIDEO_ID>

# pytestを実行
docker-compose exec app pytest

# MySQLに接続
docker-compose exec mysql mysql -u root -p
```

### データベース操作

```powershell
# MySQLクライアントで接続
docker-compose exec mysql mysql -u root -p youtube_analytics

# データベースのバックアップ
docker-compose exec mysql mysqldump -u root -p youtube_analytics > backup.sql

# データベースのリストア
Get-Content backup.sql | docker-compose exec -T mysql mysql -u root -p youtube_analytics
```

---

## デバッグ方法

### 1. ログ出力によるデバッグ

```python
import logging

logger = logging.getLogger(__name__)

def your_function():
    logger.debug("デバッグ情報")
    logger.info("通常情報")
    logger.warning("警告")
    logger.error("エラー")
```

ログファイルの確認：

```powershell
# ホスト側から確認
Get-Content ./logs/app.log -Tail 50

# エラーログのみ
Get-Content ./logs/error.log
```

### 2. インタラクティブデバッグ

```python
# コード内にブレークポイントを設定
import pdb; pdb.set_trace()
```

実行：

```powershell
# -itオプションでインタラクティブモード
docker-compose exec -it app python main.py --video-id <VIDEO_ID>
```

### 3. VSCode Remote - Containers（オプション）

VSCode拡張「Remote - Containers」を使用すると、コンテナ内で直接VSCodeを使用できます。

```
1. Remote - Containers拡張をインストール
2. Ctrl+Shift+P → "Remote-Containers: Attach to Running Container"
3. youtube-analytics-app を選択
4. コンテナ内でVSCodeが起動
```

### 4. Streamlitのデバッグ

```python
# streamlit_app.py内でst.write()を使用
import streamlit as st

st.write("デバッグ情報:", variable_name)
st.json(data)  # JSON形式で表示
```

---

## コーディング規約

詳細は [06\_命名・規約.md](./06_命名・規約.md) を参照。

### 基本ルール

```python
# 関数名: snake_case
def fetch_comments(video_id: str) -> list[dict]:
    pass

# クラス名: PascalCase
class VideoAnalyzer:
    pass

# 定数: UPPER_SNAKE_CASE
MAX_COMMENT_LENGTH = 500

# プライベート変数: _prefix
_internal_cache = {}
```

### 型ヒント

```python
# 必ず型ヒントを記述
def classify_comment(text: str) -> dict:
    """
    コメントの感情を分類する

    Args:
        text: コメント本文

    Returns:
        {"positive": float, "negative": float, "neutral": float, "language": str}
    """
    pass
```

### docstring

```python
def aggregate_video(video: dict, comments: list[dict]) -> dict:
    """
    動画とコメントを集計する

    Args:
        video: 動画情報の辞書
        comments: コメントのリスト

    Returns:
        集計結果の辞書

    Raises:
        ValueError: 入力データが不正な場合
    """
    pass
```

---

## トラブルシューティング

### コンテナが起動しない

```powershell
# エラーログを確認
docker-compose logs

# 特定のコンテナのログ
docker-compose logs mysql

# コンテナの状態を確認
docker-compose ps

# コンテナとボリュームを削除して再作成
docker-compose down -v
docker-compose up -d --build
```

### Streamlitが更新されない

```powershell
# Streamlitコンテナを再起動
docker-compose restart streamlit

# ブラウザのキャッシュをクリア（Ctrl+Shift+R）
```

### モジュールが見つからないエラー

```powershell
# requirements.txtを更新した場合は再ビルド
docker-compose build app
docker-compose up -d
```

### データベース接続エラー

```powershell
# MySQLが起動しているか確認
docker-compose ps mysql

# MySQLのログを確認
docker-compose logs mysql

# .envファイルの設定を確認
cat .env

# MySQLコンテナを再起動
docker-compose restart mysql
```

### ポート競合エラー

```powershell
# ポート使用状況を確認
netstat -ano | findstr :8501
netstat -ano | findstr :8080
netstat -ano | findstr :3306

# 使用中のプロセスを終了
# または docker-compose.yml のポート番号を変更
```

### ディスク容量不足

```powershell
# 未使用のDockerリソースを削除
docker system prune -a

# イメージ一覧
docker images

# 不要なイメージを削除
docker rmi <image-id>

# ボリューム一覧
docker volume ls

# 未使用ボリュームを削除
docker volume prune
```

### Pythonパッケージの追加

```powershell
# 1. requirements.txtに追加
echo "new-package==1.0.0" >> requirements.txt

# 2. イメージを再ビルド
docker-compose build app

# 3. コンテナを再起動
docker-compose up -d
```

---

## 開発Tips

### 1. ホットリロードの活用

`./app/` 配下のファイルはマウントされているため、保存するだけで変更が反映されます。

- **Streamlit**: 自動リロード
- **CLI**: 再実行が必要

### 2. JSONキャッシュの活用

```powershell
# 既存のJSONを使って再分析（API呼び出しなし）
docker-compose exec app python main.py --video-id <VIDEO_ID>

# キャッシュを無視して強制再取得
docker-compose exec app python main.py --video-id <VIDEO_ID> --no-cache
```

### 3. テストの高速化

```powershell
# 失敗したテストのみ再実行
docker-compose exec app pytest --lf

# 最初に失敗したテストで停止
docker-compose exec app pytest -x

# 並列実行（pytest-xdist必要）
docker-compose exec app pytest -n auto
```

### 4. Git管理のベストプラクティス

```powershell
# コミット前にチェック
git status              # 変更ファイル確認
git diff                # 差分確認

# コミットメッセージの規約
# feat: 新機能
# fix: バグ修正
# docs: ドキュメント
# style: フォーマット
# refactor: リファクタリング
# test: テスト追加
# chore: その他

# 例
git commit -m "feat: YouTube API取得のリトライ処理を追加"
git commit -m "fix: 感情分析の日本語処理を修正"
```

---

## 関連ドキュメント

- [11_Docker操作ガイド.md](./11_Docker操作ガイド.md) - Docker環境の詳細
- [06\_命名・規約.md](./06_命名・規約.md) - コーディング規約
- [09\_単体テスト仕様書.md](./09_単体テスト仕様書.md) - テスト方法
- [10\_運用設計書.md](./10_運用設計書.md) - ログ設計・障害対応
- [README.md](../README.md) - プロジェクト概要
