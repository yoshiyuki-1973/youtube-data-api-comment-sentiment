# å˜ä½“ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸
YouTubeåˆ†æãƒãƒƒãƒã‚·ã‚¹ãƒ†ãƒ 

## 1. ãƒ†ã‚¹ãƒˆæ–¹é‡
- pytestä½¿ç”¨
- å¤–éƒ¨I/Oï¼ˆAPIã€DBï¼‰ã¯ãƒ¢ãƒƒã‚¯åŒ–

### 1.1 ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| å¯¾è±¡ | ç›®æ¨™ | å‚™è€ƒ |
|-----|------|------|
| å…¨ä½“ | 80%ä»¥ä¸Š | Line CoverageåŸºæº– |
| ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ | 90%ä»¥ä¸Š | sentiment/, aggregate/ |
| I/Oå±¤ | 70%ä»¥ä¸Š | fetch/, repository/ï¼ˆãƒ¢ãƒƒã‚¯å‰æï¼‰ |

**é™¤å¤–å¯¾è±¡**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€`if __name__ == "__main__"` ãƒ–ãƒ­ãƒƒã‚¯

## 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### 2.1 å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
docker compose exec app pytest
```

### 2.2 å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œ
```bash
docker compose exec app pytest tests/test_analyzer.py -v
```

### 2.3 ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãå®Ÿè¡Œ
```bash
docker compose exec app pytest --cov=app --cov-report=html
```

## 3. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 3.1 æ„Ÿæƒ…åˆ†æï¼ˆsentiment/analyzer.pyï¼‰

| No | ãƒ†ã‚¹ãƒˆå†…å®¹ | å…¥åŠ› | æœŸå¾…å‡ºåŠ› |
|----|-----------|------|---------|
| 1 | ãƒã‚¸ãƒ†ã‚£ãƒ–åˆ¤å®š | "æœ€é«˜ï¼ã¨ã¦ã‚‚é¢ç™½ã‹ã£ãŸ" | positive > 0.5 |
| 2 | ãƒã‚¬ãƒ†ã‚£ãƒ–åˆ¤å®š | "ã¤ã¾ã‚‰ãªã„ã€æ™‚é–“ã®ç„¡é§„" | negative > 0.5 |
| 3 | ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«åˆ¤å®š | "å‹•ç”»ã‚’è¦‹ã¾ã—ãŸ" | neutral ãŒæœ€å¤§ |
| 4 | ç©ºæ–‡å­— | "" | å‡ç­‰åˆ†å¸ƒ |
| 5 | çµµæ–‡å­—ã®ã¿ | "ğŸ‘ğŸ‘ğŸ‘" | positive > neutral |

```python
# tests/test_analyzer.py
from unittest.mock import patch

def test_classify_positive():
    result = classify_comment("æœ€é«˜ï¼ã¨ã¦ã‚‚é¢ç™½ã‹ã£ãŸ")
    assert result["positive"] > 0.5
    assert "language" in result

def test_classify_negative():
    result = classify_comment("ã¤ã¾ã‚‰ãªã„ã€æ™‚é–“ã®ç„¡é§„")
    assert result["negative"] > 0.5

def test_classify_empty():
    result = classify_comment("")
    # ç©ºæ–‡å­—ã¯å‡ç­‰åˆ†å¸ƒã«è¿‘ã„
    assert abs(result["positive"] - result["negative"]) < 0.3
```

### 3.2 ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ï¼ˆfetch/youtube.pyï¼‰

| No | ãƒ†ã‚¹ãƒˆå†…å®¹ | å…¥åŠ› | æœŸå¾…å‡ºåŠ› |
|----|-----------|------|---------|
| 1 | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¶æ•° | video_id="abc123" | len(comments) <= 10 |
| 2 | ä»¶æ•°æŒ‡å®š | video_id="abc123", limit=5 | len(comments) <= 5 |
| 3 | å­˜åœ¨ã—ãªã„å‹•ç”» | video_id="invalid" | [] |
| 4 | APIã‚¨ãƒ©ãƒ¼ | (403 quota exceeded) | ä¾‹å¤–ç™ºç”Ÿ |

```python
# tests/test_fetch.py
from unittest.mock import patch, MagicMock

@patch('fetch.youtube.build')
def test_fetch_comments_default_limit(mock_build):
    mock_response = {'items': [{'snippet': {...}} for _ in range(10)]}
    mock_build.return_value.commentThreads.return_value.list.return_value.execute.return_value = mock_response

    comments = fetch_comments("abc123")
    assert len(comments) <= 10

@patch('fetch.youtube.build')
def test_fetch_comments_custom_limit(mock_build):
    mock_response = {'items': [{'snippet': {...}} for _ in range(5)]}
    mock_build.return_value.commentThreads.return_value.list.return_value.execute.return_value = mock_response

    comments = fetch_comments("abc123", comment_limit=5)
    assert len(comments) <= 5
```

### 3.3 é›†è¨ˆå‡¦ç†ï¼ˆaggregate/summarizer.pyï¼‰

| No | ãƒ†ã‚¹ãƒˆå†…å®¹ | å…¥åŠ› | æœŸå¾…å‡ºåŠ› |
|----|-----------|------|---------|
| 1 | é«˜positive | comments: positive=0.9ãŒ10ä»¶ | positive_score â‰ˆ 0.9 |
| 2 | æ··åˆ | æ§˜ã€…ãªã‚¹ã‚³ã‚¢åˆ†å¸ƒ | å¹³å‡å€¤ãŒæ­£ã—ãç®—å‡º |
| 3 | ã‚³ãƒ¡ãƒ³ãƒˆ0ä»¶ | comments: [] | total_comments=0, score=0 |

```python
# tests/test_summarizer.py
def test_aggregate_all_positive():
    video = {"video_id": "abc123"}
    comments = [{"sentiment": {"positive": 0.9, "negative": 0.05, "neutral": 0.05}} for _ in range(10)]

    result = aggregate_video(video, comments)

    assert result["total_comments"] == 10
    assert result["positive_score"] > 0.8

def test_aggregate_mixed():
    video = {"video_id": "abc123"}
    comments = [
        {"sentiment": {"positive": 0.8, "negative": 0.1, "neutral": 0.1}},
        {"sentiment": {"positive": 0.2, "negative": 0.7, "neutral": 0.1}},
    ]

    result = aggregate_video(video, comments)

    assert 0.4 < result["positive_score"] < 0.6
    assert 0.3 < result["negative_score"] < 0.5

def test_aggregate_empty():
    video = {"video_id": "abc123"}
    comments = []

    result = aggregate_video(video, comments)

    assert result["total_comments"] == 0
```

### 3.4 DBæ“ä½œï¼ˆrepository/mysql.pyï¼‰

| No | ãƒ†ã‚¹ãƒˆå†…å®¹ | å…¥åŠ› | æœŸå¾…å‹•ä½œ |
|----|-----------|------|---------|
| 1 | æ–°è¦ä¿å­˜ | æ–°è¦video_id | INSERTå®Ÿè¡Œ |
| 2 | æ›´æ–°ä¿å­˜ | æ—¢å­˜video_id | UPDATEå®Ÿè¡Œ |
| 3 | æ¥ç¶šã‚¨ãƒ©ãƒ¼ | (DBåœæ­¢ä¸­) | ä¾‹å¤–ç™ºç”Ÿ |

```python
# tests/test_repository.py
from unittest.mock import patch, MagicMock

@patch('repository.mysql.get_connection')
def test_save_video(mock_conn):
    mock_cursor = MagicMock()
    mock_conn.return_value.cursor.return_value.__enter__.return_value = mock_cursor

    video = {"video_id": "abc123", "title": "Test Video", ...}
    save_video(video)

    mock_cursor.execute.assert_called_once()
```

## 4. ãƒ¢ãƒƒã‚¯è¨­è¨ˆ

### 4.1 ãƒ¢ãƒƒã‚¯å¯¾è±¡ä¸€è¦§

| å¯¾è±¡ | ãƒ¢ãƒƒã‚¯æ–¹æ³• | ç”¨é€” |
|-----|-----------|------|
| YouTube Data API | `unittest.mock.patch` | APIå‘¼ã³å‡ºã—ã®ä»£æ›¿ |
| MySQLæ¥ç¶š | `unittest.mock.patch` | DBæ“ä½œã®ä»£æ›¿ |
| Transformersãƒ¢ãƒ‡ãƒ« | `unittest.mock.patch` | ãƒ¢ãƒ‡ãƒ«æ¨è«–ã®ä»£æ›¿ |

### 4.2 YouTube Data API ãƒ¢ãƒƒã‚¯

`googleapiclient.discovery.build` ã‚’ãƒ‘ãƒƒãƒã—ã€ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã‚’MagicMockã§å†ç¾ã™ã‚‹ã€‚

```python
# tests/test_fetch.py
from unittest.mock import patch, MagicMock

@patch('fetch.youtube.build')
def test_fetch_video(mock_build):
    # ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¨­å®š
    mock_response = {
        'items': [{
            'id': 'dQw4w9WgXcQ',
            'snippet': {
                'title': 'Test Video',
                'channelId': 'UC123',
                'channelTitle': 'Test Channel',
                'publishedAt': '2025-01-01T00:00:00Z'
            },
            'statistics': {
                'viewCount': '1000',
                'likeCount': '100',
                'commentCount': '10'
            }
        }]
    }

    # ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã®ãƒ¢ãƒƒã‚¯
    mock_build.return_value.videos.return_value.list.return_value.execute.return_value = mock_response

    result = fetch_video('dQw4w9WgXcQ')

    assert result['id'] == 'dQw4w9WgXcQ'
    assert result['snippet']['title'] == 'Test Video'

@patch('fetch.youtube.build')
def test_fetch_video_api_error(mock_build):
    """APIã‚¯ã‚©ãƒ¼ã‚¿è¶…éã®ãƒ†ã‚¹ãƒˆ"""
    from googleapiclient.errors import HttpError

    mock_build.return_value.videos.return_value.list.return_value.execute.side_effect = \
        HttpError(resp={'status': '403'}, content=b'quota exceeded')

    with pytest.raises(HttpError):
        fetch_video('abc123')
```

### 4.3 MySQL ãƒ¢ãƒƒã‚¯

```python
# tests/test_repository.py
from unittest.mock import patch, MagicMock

@patch('repository.mysql.get_connection')
def test_save_video_insert(mock_get_conn):
    """æ–°è¦å‹•ç”»ã®ä¿å­˜"""
    mock_conn = MagicMock()
    mock_cursor = MagicMock()
    mock_get_conn.return_value = mock_conn
    mock_conn.cursor.return_value.__enter__.return_value = mock_cursor

    video = {
        'video_id': 'abc123',
        'title': 'Test Video',
        'channel_id': 'UC123'
    }

    save_video(video)

    # SQLå®Ÿè¡Œã‚’æ¤œè¨¼
    mock_cursor.execute.assert_called_once()
    mock_conn.commit.assert_called_once()

@patch('repository.mysql.get_connection')
def test_save_video_connection_error(mock_get_conn):
    """DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ãƒ†ã‚¹ãƒˆ"""
    import mysql.connector

    mock_get_conn.side_effect = mysql.connector.Error("Connection refused")

    with pytest.raises(mysql.connector.Error):
        save_video({'video_id': 'abc123'})
```

### 4.4 Transformers ãƒ¢ãƒƒã‚¯

```python
# tests/test_analyzer.py
from unittest.mock import patch, MagicMock
import torch

@patch('sentiment.analyzer._ja_model_1')
@patch('sentiment.analyzer._ja_tokenizer_1')
def test_classify_with_mock(mock_tokenizer, mock_model):
    """ãƒ¢ãƒ‡ãƒ«æ¨è«–ã®ãƒ¢ãƒƒã‚¯"""
    # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ¢ãƒƒã‚¯
    mock_tokenizer.return_value = {'input_ids': torch.tensor([[1, 2, 3]])}

    # ãƒ¢ãƒ‡ãƒ«å‡ºåŠ›ã®ãƒ¢ãƒƒã‚¯ï¼ˆlogitså½¢å¼ï¼‰
    mock_output = MagicMock()
    mock_output.logits = torch.tensor([[0.1, 0.1, 0.8]])  # posé«˜ã‚
    mock_model.return_value = mock_output

    result = classify_comment('ç´ æ™´ã‚‰ã—ã„å‹•ç”»')

    assert result['positive'] > 0.5
    assert 'language' in result

def test_classify_fallback_to_rules():
    """ãƒ¢ãƒ‡ãƒ«æœªãƒ­ãƒ¼ãƒ‰æ™‚ã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
    result = classify_comment('æœ€é«˜ï¼')
    # ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§ã‚‚çµæœãŒè¿”ã‚‹
    assert 'positive' in result
    assert 'negative' in result
    assert 'neutral' in result
```

### 4.5 ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ï¼ˆconftest.pyï¼‰

å…±é€šã®ãƒ¢ãƒƒã‚¯è¨­å®šã‚’ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£åŒ–ã™ã‚‹ã€‚

```python
# tests/conftest.py
import pytest
from unittest.mock import patch, MagicMock

@pytest.fixture
def mock_youtube_api():
    """YouTube API ãƒ¢ãƒƒã‚¯ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
    with patch('fetch.youtube.build') as mock_build:
        mock_api = MagicMock()
        mock_build.return_value = mock_api
        yield mock_api

@pytest.fixture
def mock_db_connection():
    """DBæ¥ç¶šãƒ¢ãƒƒã‚¯ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
    with patch('repository.mysql.get_connection') as mock_conn:
        mock_cursor = MagicMock()
        mock_conn.return_value.cursor.return_value.__enter__.return_value = mock_cursor
        yield {'connection': mock_conn, 'cursor': mock_cursor}

# ä½¿ç”¨ä¾‹
def test_with_fixtures(mock_youtube_api, mock_db_connection):
    mock_youtube_api.videos.return_value.list.return_value.execute.return_value = {...}
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```

### 4.6 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†

```
tests/
â”œâ”€â”€ conftest.py           # å…±é€šãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
â”œâ”€â”€ fixtures/
â”‚   â”œâ”€â”€ video_response.json      # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µãƒ³ãƒ—ãƒ«
â”‚   â””â”€â”€ comments_response.json   # ã‚³ãƒ¡ãƒ³ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µãƒ³ãƒ—ãƒ«
â””â”€â”€ test_*.py
```

```python
# ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£JSONã®èª­ã¿è¾¼ã¿
import json
from pathlib import Path

def load_fixture(name: str) -> dict:
    path = Path(__file__).parent / 'fixtures' / name
    return json.loads(path.read_text())

def test_with_fixture_file(mock_youtube_api):
    mock_youtube_api.videos.return_value.list.return_value.execute.return_value = \
        load_fixture('video_response.json')
```
